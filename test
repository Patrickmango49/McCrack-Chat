<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>McCrack Chat</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * { box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI', Roboto, sans-serif; }
        
        /* Global Blurry B&W Gradient Background */
        body, html { 
            width:100%; 
            height:100%; 
            background: radial-gradient(circle at center, #333 0%, #000 100%);
            display:flex; 
            justify-content:center; 
            align-items:center; 
            color: white; 
            overflow: hidden; 
        }
        
        #app { 
            width:98%; 
            max-width:1400px; 
            height:95vh; 
            display:flex; 
            border-radius:24px; 
            overflow:hidden; 
            background: rgba(22, 22, 22, 0.95); 
            box-shadow: 0 50px 100px rgba(0,0,0,0.9); 
            border: 1px solid #333;
            backdrop-filter: blur(10px);
        }
        
        /* Sidebar */
        #sidebar { width:280px; background:#0a0a0a; padding:25px; display:flex; flex-direction:column; gap:15px; border-right: 1px solid #222; flex-shrink: 0; }
        
        #sidebar h2 { 
            color: #ffffff; 
            letter-spacing: 3px; 
            font-size: 28px; 
            text-align: center; 
            margin-bottom: 10px; 
            font-weight: 900; 
            text-shadow: 0 0 15px rgba(255,255,255,0.2);
        }

        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-size: 10px; color: #555; font-weight: bold; letter-spacing: 1px; }
        #sidebar input { padding:12px; border-radius:10px; border:1px solid #333; background:#111; color:white; outline: none; }
        
        #sidebar button { padding:12px; border:none; border-radius:10px; background:#444; color:white; cursor:pointer; font-weight:bold; transition: 0.2s; }
        #sidebar button:hover { background:#666; }
        #createBtn { background: #fff !important; color: #000 !important; }

        /* Recent Rooms */
        #recent-rooms-container { margin-top: 30px; display: flex; flex-direction: column; gap: 10px; }
        #recent-rooms-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 5px; }
        #recent-rooms-list { display: flex; flex-direction: column; gap: 6px; }
        .room-history-btn { background: #111 !important; border: 1px solid #222 !important; text-align: left !important; font-size: 13px !important; color: #888 !important; cursor: pointer; }
        .room-history-btn:hover { border-color: #fff !important; color: #fff !important; }

        /* Chat Window */
        #chat-area { flex:1; display:flex; flex-direction:column; background: #000000; }
        #room-header { padding: 20px 30px; background: #0a0a0a; border-bottom: 1px solid #222; font-weight: bold; color: #ffffff; font-size: 20px; letter-spacing: 1px; }
        #chat { flex:1; overflow-y:auto; padding:30px; display:flex; flex-direction:column; gap:15px; }
        
        .message { 
            max-width:75%; padding:12px 18px; border-radius:18px; font-size: 14px; 
            background: #1a1a1a; align-self:flex-start; line-height: 1.5; border: 1px solid #222; 
        }
        .mine { background:#ffffff; color: #000; align-self:flex-end; border: none; }
        .mine .msg-info { color: #555; }
        .msg-info { display:block; font-size:10px; font-weight: bold; margin-bottom: 4px; opacity: 0.6; }

        /* Images in chat */
        .chat-img { max-width: 100%; border-radius: 12px; margin-top: 8px; display: block; border: 1px solid #333; cursor: zoom-in; }

        /* Typing Indicator Styling */
        #typing-indicator { 
            padding: 0 30px 5px 30px; 
            font-size: 11px; 
            color: #555; 
            height: 18px; 
            font-style: italic; 
            background: #000; 
        }

        /* Input Area */
        #input-area { display:flex; padding:25px; background: #0a0a0a; gap: 10px; border-top: 1px solid #222; align-items: center; }
        #message-input { flex:1; padding:15px 25px; border-radius:30px; border:1px solid #333; background:#000; color:white; outline: none; }
        
        /* Circular Upload Button */
        .action-btn { 
            width: 45px; height: 45px; border-radius: 50%; border: 1px solid #333; 
            background: #111; color: white; cursor: pointer; font-size: 22px; 
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: 0.2s;
        }
        .action-btn:hover { background: #222; border-color: #555; }
        
        #sendBtn { padding:0 30px; height: 45px; border-radius:30px; border:none; background:#fff; color:#000; cursor:pointer; font-weight:bold; }

        /* Modals */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); backdrop-filter: blur(10px); justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background:#111; padding:40px; border-radius:24px; width:400px; display:flex; flex-direction:column; gap:20px; border: 1px solid #333; text-align: center; }
        .confirm-btn { background:#fff; color:#000; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        
        #status-display { margin-top: auto; font-size: 11px; font-weight: bold; letter-spacing: 1px; }
        .status-online { color: #00ff88; }
        .status-offline { color: #ff4444; }
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <h2>McCrack</h2>
        <div class="input-group">
            <label>DISPLAY NAME</label>
            <input id="user-display-name" placeholder="Enter name...">
        </div>
        <hr style="border: 0; border-top: 1px solid #222; margin: 10px 0;">
        <button id="createBtn">Create New Room</button>
        <button id="joinBtn">Join Room</button>
        
        <div id="recent-rooms-container">
            <div id="recent-rooms-header">
                <label style='font-size:10px; color:#555; font-weight:bold;'>MY ROOMS</label>
                <span onclick="clearRecentRooms()" style="font-size:10px; color:#f44; cursor:pointer;">CLEAR</span>
            </div>
            <div id="recent-rooms-list"></div>
        </div>

        <div id="status-display" class="status-offline">System: Connecting...</div>
    </div>
    
    <div id="chat-area">
        <div id="room-header">Welcome</div>
        <div id="chat"></div>
        <div id="typing-indicator"></div>
        <div id="input-area">
            <input type="file" id="fileInput" accept="image/*" style="display:none">
            <button class="action-btn" id="uploadBtn" disabled>+</button>
            <input id="message-input" placeholder="Join a room..." disabled>
            <button id="sendBtn" disabled>Send</button>
        </div>
    </div>
</div>

<div id="room-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title" style="color:#fff">Room</h3>
        <input id="room-name-input" placeholder="Room name...">
        <button id="confirmRoomBtn" class="confirm-btn">Confirm & Enter</button>
        <button onclick="closeModal()" style="background:transparent; color:#555; border:none; cursor:pointer;">Cancel</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SUPABASE_URL = "https://agcrweayleevlkgcmqpy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnY3J3ZWF5bGVldmxrZ2NtcXB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MzI5ODcsImV4cCI6MjA4NzEwODk4N30.6ROZmRjDORSrfHP9yeZ_ofRHueHnq5K-C9c_jjxqBwQ";
    
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let activeRoom = "";
    let myUsername = "";
    let chatChannel = null;
    let typingTimeout = null;

    const chatBox = document.getElementById("chat");
    const msgInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("sendBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");
    const statusDisplay = document.getElementById("status-display");
    const roomModal = document.getElementById("room-modal");
    const roomInput = document.getElementById("room-name-input");
    const nameInput = document.getElementById("user-display-name");
    const recentRoomsList = document.getElementById("recent-rooms-list");
    const typingIndicator = document.getElementById("typing-indicator");

    function renderRecentRooms() {
        const savedRooms = JSON.parse(localStorage.getItem("myRooms") || "[]");
        recentRoomsList.innerHTML = "";
        savedRooms.forEach(roomName => {
            const btn = document.createElement("button");
            btn.className = "room-history-btn";
            btn.innerText = "# " + roomName;
            btn.onclick = () => {
                roomInput.value = roomName;
                if (nameInput.value.trim() !== "") {
                    window.modalMode = "join";
                    document.getElementById("confirmRoomBtn").click();
                } else {
                    openModal("Join Room", "join");
                    roomInput.value = roomName;
                }
            };
            recentRoomsList.appendChild(btn);
        });
    }

    function saveRoomLocally(roomName) {
        let savedRooms = JSON.parse(localStorage.getItem("myRooms") || "[]");
        savedRooms = savedRooms.filter(r => r !== roomName);
        savedRooms.unshift(roomName);
        if(savedRooms.length > 5) savedRooms.pop();
        localStorage.setItem("myRooms", JSON.stringify(savedRooms));
        renderRecentRooms();
    }

    function clearRecentRooms() { localStorage.removeItem("myRooms"); renderRecentRooms(); }

    renderRecentRooms();

    async function checkSystem() {
        try {
            const { error } = await _supabase.from('rooms').select('name').limit(1);
            if(!error) {
                statusDisplay.innerText = "System: Online";
                statusDisplay.className = "status-online";
            }
        } catch (e) { statusDisplay.className = "status-offline"; }
    }
    checkSystem();

    function openModal(title, mode) {
        window.modalMode = mode;
        document.getElementById("modal-title").innerText = title;
        roomModal.style.display = "flex";
        roomInput.focus();
    }

    function closeModal() { roomModal.style.display = "none"; roomInput.value = ""; }

    document.getElementById("createBtn").onclick = () => openModal("Create Room", "create");
    document.getElementById("joinBtn").onclick = () => openModal("Join Room", "join");

    document.getElementById("confirmRoomBtn").onclick = async () => {
        const r = roomInput.value.trim().toLowerCase();
        const u = nameInput.value.trim();
        if(!r || !u) return;

        try {
            if (window.modalMode === "create") {
                await _supabase.from('rooms').insert([{ name: r }]);
            } else {
                const { data } = await _supabase.from('rooms').select('*').eq('name', r).maybeSingle();
                if (!data) { alert("Room not found!"); return; }
            }
            saveRoomLocally(r);
            activeRoom = r;
            myUsername = u;
            document.getElementById("room-header").innerText = "# " + r;
            msgInput.disabled = false;
            sendBtn.disabled = false;
            uploadBtn.disabled = false;
            closeModal();
            connectToRoom();
        } catch (err) { alert("Error: " + err.message); }
    };

    async function connectToRoom() {
        chatBox.innerHTML = "<p style='text-align:center; opacity:0.3; margin-top:20px;'>Syncing...</p>";
        const { data } = await _supabase.from("messages").select("*").eq("room", activeRoom).order("created_at", { ascending: true });
        chatBox.innerHTML = "";
        if (data) data.forEach(msg => addMessage(msg));

        if(chatChannel) await _supabase.removeChannel(chatChannel);
        
        chatChannel = _supabase.channel(`room_${activeRoom}`, {
            config: { broadcast: { self: false } }
        })
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room=eq.${activeRoom}` }, 
            payload => addMessage(payload.new)
        )
        .on('broadcast', { event: 'typing' }, payload => {
            if (payload.payload.user !== myUsername) {
                typingIndicator.innerText = `${payload.payload.user} is typing...`;
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => { typingIndicator.innerText = ""; }, 2000);
            }
        })
        .subscribe();
    }

    function addMessage(msg) {
        const div = document.createElement("div");
        const isMe = msg.username === myUsername;
        div.className = `message ${isMe ? 'mine' : ''}`;
        
        let content = msg.content;
        const isUrl = content.startsWith("http");
        const hasImgExt = /\.(png|jpg|jpeg|gif|webp)/i.test(content);
        const isStoragePath = content.includes("chat-images");

        if (isUrl && (hasImgExt || isStoragePath)) {
            content = `<img src="${content}" class="chat-img" onclick="window.open('${content}')">`;
        }

        div.innerHTML = `<span class="msg-info">${msg.username}</span>${content}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Typing Event Trigger
    msgInput.oninput = () => {
        if (chatChannel) {
            chatChannel.send({
                type: 'broadcast',
                event: 'typing',
                payload: { user: myUsername }
            });
        }
    };

    uploadBtn.onclick = () => fileInput.click();
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        uploadBtn.innerText = "...";
        const fileExt = file.name.split('.').pop();
        const fileName = `${Math.random()}.${fileExt}`;
        const filePath = `${activeRoom}/${fileName}`;
        try {
            const { error } = await _supabase.storage.from('chat-images').upload(filePath, file);
            if (error) throw error;
            const { data: urlData } = _supabase.storage.from('chat-images').getPublicUrl(filePath);
            await _supabase.from("messages").insert([{ 
                room: activeRoom, username: myUsername, content: urlData.publicUrl 
            }]);
        } catch (err) {
            alert("Upload failed: " + err.message);
        } finally {
            uploadBtn.innerText = "+";
            fileInput.value = "";
        }
    };

    async function send() {
        const text = msgInput.value.trim();
        if(!text) return;
        msgInput.value = "";
        await _supabase.from("messages").insert([{ room: activeRoom, username: myUsername, content: text }]);
    }

    sendBtn.onclick = send;
    msgInput.onkeypress = (e) => { if(e.key === "Enter") send(); };
</script>
</body>
</html>
