<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>McCrack Chat</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * { box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI', Roboto, sans-serif; }
        body, html { width:100%; height:100%; background:#0a0a0a; display:flex; justify-content:center; align-items:center; color: white; overflow: hidden; }
        
        /* App Container */
        #app { width:98%; max-width:1400px; height:95vh; display:flex; border-radius:20px; overflow:hidden; background:#161616; box-shadow:0 20px 50px rgba(0,0,0,0.5); border: 1px solid #2a2a2a; }
        
        /* Sidebar Styling */
        #sidebar { width:280px; background:#111; padding:25px; display:flex; flex-direction:column; gap:15px; border-right: 1px solid #2a2a2a; flex-shrink: 0; }
        #sidebar h2 { color: #00aaff; letter-spacing: 2px; font-size: 28px; text-align: center; margin-bottom: 10px; font-weight: 800; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-size: 10px; color: #555; font-weight: bold; letter-spacing: 1px; }
        #sidebar input { padding:12px; border-radius:10px; border:1px solid #2a2a2a; background:#1a1a1a; color:white; outline: none; transition: 0.3s; }
        #sidebar input:focus { border-color: #00aaff; box-shadow: 0 0 10px rgba(0,170,255,0.2); }
        #sidebar button { padding:12px; border:none; border-radius:10px; background:#00aaff; color:white; cursor:pointer; font-weight:bold; transition: 0.2s; }
        #sidebar button:hover { background:#00d4ff; transform: translateY(-2px); }

        /* Recent Rooms List */
        #recent-rooms-header { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .room-history-btn { background: #1a1a1a !important; border: 1px solid #2a2a2a !important; text-align: left !important; font-size: 13px !important; margin-bottom: 5px; opacity: 0.8; }
        .room-history-btn:hover { opacity: 1; border-color: #444 !important; }

        /* Chat Area */
        #chat-area { flex:1; display:flex; flex-direction:column; background:#121212; }
        #room-header { padding: 20px 30px; background: #1a1a1a; border-bottom: 1px solid #2a2a2a; font-weight: bold; color: #00aaff; font-size: 20px; display: flex; align-items: center; gap: 10px; }
        #chat { flex:1; overflow-y:auto; padding:30px; display:flex; flex-direction:column; gap:15px; }
        
        /* Messages */
        .message { max-width:75%; padding:12px 18px; border-radius:18px; font-size: 14px; background:#222; align-self:flex-start; line-height: 1.5; border-bottom-left-radius: 4px; }
        .mine { background:#00aaff; align-self:flex-end; border-bottom-left-radius: 18px; border-bottom-right-radius: 4px; color: white; }
        .msg-info { display:block; font-size:10px; font-weight: bold; margin-bottom: 4px; opacity: 0.6; }

        /* Input Bar */
        #input-area { display:flex; padding:25px; background:#111; gap:15px; border-top: 1px solid #2a2a2a; }
        #message-input { flex:1; padding:15px 25px; border-radius:30px; border:1px solid #2a2a2a; background:#1a1a1a; color:white; outline: none; transition: 0.3s; }
        #message-input:focus { border-color: #00aaff; }
        #sendBtn { padding:0 35px; border-radius:30px; border:none; background:#00aaff; color:white; cursor:pointer; font-weight:bold; }

        /* MODAL STYLING (The "Nicer" Window) */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(5px); justify-content:center; align-items:center; z-index:1000; transition: 0.3s; }
        .modal.show { display:flex; }
        .modal-content { 
            background:#1c1c1c; padding:40px; border-radius:24px; width:400px; 
            display:flex; flex-direction:column; gap:20px; 
            border: 1px solid #333; box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            transform: scale(0.9); transition: 0.3s;
        }
        .modal.show .modal-content { transform: scale(1); }
        .modal-content h3 { color:#00aaff; text-align:center; font-size: 22px; margin-bottom: 5px; }
        .modal-content input { padding:15px; border-radius:12px; border:1px solid #333; background:#111; color:white; outline: none; font-size: 16px; }
        .modal-content button { padding:15px; border-radius:12px; border:none; font-weight:bold; cursor:pointer; }
        .confirm-btn { background:#00aaff; color:white; }
        .cancel-btn { background:transparent; color:#666; font-size: 13px; }
        
        #status-display { margin-top: auto; font-size: 11px; color: #333; font-weight: bold; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <h2>McCrack</h2>
        <div class="input-group">
            <label>DISPLAY NAME</label>
            <input id="user-display-name" placeholder="Enter your name...">
        </div>
        <hr style="border: 0; border-top: 1px solid #2a2a2a; margin: 10px 0;">
        <button id="createBtn">Create New Room</button>
        <button id="joinBtn" style="background: #222;">Join Room</button>
        
        <div id="recent-rooms-container">
            <div id="recent-rooms-header">
                <label style='font-size:10px; color:#555; font-weight:bold;'>MY ROOMS</label>
                <span onclick="clearRecentRooms()" style="font-size:10px; color:#f44; cursor:pointer;">CLEAR</span>
            </div>
            <div id="recent-rooms-list"></div>
        </div>

        <div id="status-display">System: Connecting...</div>
    </div>
    
    <div id="chat-area">
        <div id="room-header">Welcome to McCrack</div>
        <div id="chat"></div>
        <div id="input-area">
            <input id="message-input" placeholder="Join a room to start chatting..." disabled>
            <button id="sendBtn" disabled>Send</button>
        </div>
    </div>
</div>

<div id="room-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title">Room</h3>
        <input id="room-name-input" placeholder="Enter room name...">
        <button id="confirmRoomBtn" class="confirm-btn">Confirm & Enter</button>
        <button onclick="closeModal()" class="cancel-btn">Go Back</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SUPABASE_URL = "https://agcrweayleevlkgcmqpy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnY3J3ZWF5bGVldmxrZ2NtcXB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MzI5ODcsImV4cCI6MjA4NzEwODk4N30.6ROZmRjDORSrfHP9yeZ_ofRHueHnq5K-C9c_jjxqBwQ";
    
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let activeRoom = "";
    let myUsername = "";
    let chatChannel = null;

    const chatBox = document.getElementById("chat");
    const msgInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("sendBtn");
    const statusDisplay = document.getElementById("status-display");
    const roomModal = document.getElementById("room-modal");
    const roomInput = document.getElementById("room-name-input");
    const nameInput = document.getElementById("user-display-name");
    const recentRoomsList = document.getElementById("recent-rooms-list");

// --- RECENT ROOMS LOGIC ---
    function renderRecentRooms() {
        const savedRooms = JSON.parse(localStorage.getItem("myRooms") || "[]");
        recentRoomsList.innerHTML = "";
        
        savedRooms.forEach(roomName => {
            const btn = document.createElement("button");
            btn.className = "room-history-btn";
            btn.innerText = "# " + roomName;
            btn.onclick = () => {
                // Fill the room name
                roomInput.value = roomName;
                
                // If the user already has a display name, just join immediately
                if (nameInput.value.trim() !== "") {
                    window.modalMode = "join"; // Ensure it checks if room exists
                    document.getElementById("confirmRoomBtn").click();
                } else {
                    // If no name, open the modal so they can enter one
                    openModal("Join Room", "join");
                    roomInput.value = roomName;
                }
            };
            recentRoomsList.appendChild(btn);
        });
    }

    function saveRoomLocally(roomName) {
        let savedRooms = JSON.parse(localStorage.getItem("myRooms") || "[]");
        // Remove if exists (to move it to the top)
        savedRooms = savedRooms.filter(r => r !== roomName);
        savedRooms.unshift(roomName); 
        
        if(savedRooms.length > 8) savedRooms.pop(); // Show up to 8 rooms
        localStorage.setItem("myRooms", JSON.stringify(savedRooms));
        renderRecentRooms();
    }
    function clearRecentRooms() {
        localStorage.removeItem("myRooms");
        renderRecentRooms();
    }

    renderRecentRooms();

    // --- SYSTEM CHECK ---
    async function checkSystem() {
        try {
            const { error } = await _supabase.from('rooms').select('name').limit(1);
            if (error) throw error;
            statusDisplay.innerText = "System: Online (Live)";
        } catch (e) {
            statusDisplay.innerText = "System: Offline";
        }
    }
    checkSystem();

    // --- MODAL LOGIC ---
    function openModal(title, mode) {
        window.modalMode = mode;
        document.getElementById("modal-title").innerText = title;
        roomModal.classList.add('show');
        roomInput.focus();
    }

    function closeModal() { roomModal.classList.remove('show'); roomInput.value = ""; }

    document.getElementById("createBtn").onclick = () => openModal("Create a New Room", "create");
    document.getElementById("joinBtn").onclick = () => openModal("Join Existing Room", "join");

    document.getElementById("confirmRoomBtn").onclick = async () => {
        const r = roomInput.value.trim().toLowerCase(); // Lowercase for consistency
        const u = nameInput.value.trim();
        if(!r || !u) { alert("Please enter both your name and a room name!"); return; }

        try {
            if (window.modalMode === "create") {
                const { error } = await _supabase.from('rooms').insert([{ name: r }]);
                if (error && error.code !== '23505') throw error; 
            } else {
                const { data } = await _supabase.from('rooms').select('*').eq('name', r).maybeSingle();
                if (!data) { alert("Room not found!"); return; }
            }
            
            saveRoomLocally(r);
            activeRoom = r;
            myUsername = u;
            document.getElementById("room-header").innerText = "# " + r;
            msgInput.disabled = false;
            sendBtn.disabled = false;
            msgInput.placeholder = `Message as ${u}...`;
            closeModal();
            connectToRoom();
        } catch (err) {
            alert("Database Error: " + err.message);
        }
    };

    async function connectToRoom() {
        chatBox.innerHTML = "<p style='text-align:center; opacity:0.3; margin-top:20px;'>Fetching history...</p>";
        const { data } = await _supabase.from("messages").select("*").eq("room", activeRoom).order("created_at", { ascending: true });
        chatBox.innerHTML = "";
        if (data) data.forEach(msg => addMessage(msg));

        if(chatChannel) await _supabase.removeChannel(chatChannel);
        
        chatChannel = _supabase.channel(`room_${activeRoom}`)
            .on('postgres_changes', { 
                event: 'INSERT', 
                schema: 'public', 
                table: 'messages', 
                filter: `room=eq.${activeRoom}` 
            }, payload => addMessage(payload.new))
            .subscribe();
    }

    function addMessage(msg) {
        const div = document.createElement("div");
        const isMe = msg.username === myUsername;
        div.className = `message ${isMe ? 'mine' : ''}`;
        div.innerHTML = `<span class="msg-info">${msg.username}</span>${msg.content}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function send() {
        const text = msgInput.value.trim();
        if(!text) return;
        msgInput.value = "";
        await _supabase.from("messages").insert([{ room: activeRoom, username: myUsername, content: text }]);
    }

    sendBtn.onclick = send;
    msgInput.onkeypress = (e) => { if(e.key === "Enter") send(); };
</script>
</body>
</html>

